<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Registration</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h2>Event Registration</h2>
    <div id="map"></div>
    <div id="registration" class="hidden">
        <h3>Register for Event</h3>
        <form id="registrationForm" action="submit_registration.php" method="POST">
            <input type="hidden" id="event_id" name="event_id">
            <input type="hidden" id="student_id" name="student_id" value="<!-- Your PHP Code to Inject Student ID -->">
            <button type="submit">Register</button>
        </form>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetch('get_event_details.php') // Fetch event details from server
                .then(response => response.json())
                .then(data => {
                    const eventLocation = [data.latitude, data.longitude];
                    const eventDuration = data.duration * 60 * 1000; // Convert minutes to milliseconds

                    const map = L.map('map').setView(eventLocation, 15);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    const marker = L.marker(eventLocation, { draggable: false }).addTo(map);

                    const startTime = Date.now();

                    if (navigator.geolocation) {
                        navigator.geolocation.watchPosition(
                            position => {
                                const userLocation = [position.coords.latitude, position.coords.longitude];

                                const distance = getDistance(userLocation, eventLocation);

                                if (distance < 50) { // 50 meters radius
                                    if (Date.now() - startTime > eventDuration) {
                                        document.getElementById('registration').classList.remove('hidden');
                                    }
                                }
                            },
                            error => {
                                console.error('Geolocation error:', error);
                            },
                            { enableHighAccuracy: true }
                        );
                    } else {
                        console.error('Geolocation not supported');
                    }

                    function getDistance(loc1, loc2) {
                        const R = 6371e3; // meters
                        const φ1 = loc1[0] * Math.PI / 180;
                        const φ2 = loc2[0] * Math.PI / 180;
                        const Δφ = (loc2[0] - loc1[0]) * Math.PI / 180;
                        const Δλ = (loc2[1] - loc1[1]) * Math.PI / 180;

                        const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                            Math.cos(φ1) * Math.cos(φ2) *
                            Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                        return R * c;
                    }
                });
        });
    </script>
</body>
</html>
